<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contador de Asistencias</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SheetJS para exportar a Excel -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        .container {
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Contador de Asistencias</h1>
        
        <div class="form-group">
            <label for="csvFile" class="form-label">Seleccionar archivo CSV:</label>
            <input type="file" class="form-control" id="csvFile" accept=".csv">
            <button class="btn btn-info mt-2" onclick="showCsvData()" id="viewCsvBtn" disabled>Ver Datos del CSV</button>
        </div>

        <!-- Modal para mostrar datos CSV -->
        <div class="modal fade" id="csvModal" tabindex="-1" aria-labelledby="csvModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="csvModalLabel">Datos del CSV</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Filtros -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="filterName" class="form-label">Filtrar por Nombre:</label>
                                <input type="text" class="form-control" id="filterName" placeholder="Escriba un nombre...">
                            </div>
                            <div class="col-md-4">
                                <label for="filterDateStart" class="form-label">Fecha Desde:</label>
                                <input type="date" class="form-control" id="filterDateStart">
                            </div>
                            <div class="col-md-4">
                                <label for="filterDateEnd" class="form-label">Fecha Hasta:</label>
                                <input type="date" class="form-control" id="filterDateEnd">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <button class="btn btn-primary" onclick="applyFilters()">Aplicar Filtros</button>
                                <button class="btn btn-secondary" onclick="clearFilters()">Limpiar Filtros</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" id="csvTable">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="startDate" class="form-label">Fecha inicial:</label>
                <input type="date" class="form-control" id="startDate">
            </div>
            <div class="col-md-6">
                <label for="endDate" class="form-label">Fecha final:</label>
                <input type="date" class="form-control" id="endDate">
            </div>
        </div>

        <button class="btn btn-primary mb-3" onclick="processData()">Procesar Datos</button>
        <button class="btn btn-success mb-3 ms-2" onclick="exportToExcel()" id="exportBtn" disabled>Exportar a Excel</button>

        <!-- Controles para la tabla de resultados -->
        <div class="row mb-2">
            <div class="col-md-3 d-flex align-items-center">
                <input type="checkbox" id="onlyMissing" class="form-check-input me-2">
                <label for="onlyMissing" class="form-check-label">Mostrar solo con ausencias</label>
            </div>
            <div class="col-md-3 d-flex align-items-center">
                <input type="checkbox" id="excludeRest" class="form-check-input me-2">
                <label for="excludeRest" class="form-check-label me-2">Excluir día de descanso:</label>
                <select id="restDaySelect" class="form-select" style="width:160px;">
                    <option value="">-- Seleccionar día --</option>
                    <option value="1">Lunes</option>
                    <option value="2">Martes</option>
                    <option value="3">Miércoles</option>
                    <option value="4">Jueves</option>
                    <option value="5">Viernes</option>
                    <option value="6">Sábado</option>
                    <option value="0">Domingo</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-center">
                <label for="truncateCount" class="me-2 mb-0">Mostrar fechas (máx):</label>
                <input type="number" id="truncateCount" class="form-control" style="width:100px;" value="3" min="1">
            </div>
            <div class="col-md-3 d-flex align-items-center">
                <button class="btn btn-outline-secondary" onclick="expandedSet.clear(); updateTable();">Restablecer Ver Más</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped" id="resultTable">
                <thead>
                    <tr>
                        <th>N°</th>
                        <th>Nombre</th>
                        <th>Número de Asistencias</th>
                        <th>Días sin Asistencia</th>
                        <th>Fechas sin Asistencia</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        let processedData = [];
        let csvData = null;
        let csvModal = null;
        let originalCsvData = null; // Para mantener una copia de los datos originales

        // Manejador de evento para cuando se selecciona un archivo
        document.getElementById('csvFile').addEventListener('change', function(e) {
            document.getElementById('viewCsvBtn').disabled = !e.target.files[0];
        });

        // Auto-recargar la tabla cuando cambian los controles (checkbox, rest day o límite de fechas mostradas)
        const onlyMissingEl = document.getElementById('onlyMissing');
        if (onlyMissingEl) {
            onlyMissingEl.addEventListener('change', function() {
                updateTable();
            });
        }

        const truncateEl = document.getElementById('truncateCount');
        if (truncateEl) {
            truncateEl.addEventListener('input', function() {
                updateTable();
            });
        }

        const excludeRestEl = document.getElementById('excludeRest');
        if (excludeRestEl) {
            excludeRestEl.addEventListener('change', function() {
                updateTable();
            });
        }

        const restDaySelectEl = document.getElementById('restDaySelect');
        if (restDaySelectEl) {
            restDaySelectEl.addEventListener('change', function() {
                // Si hay una selección y el checkbox no está marcado, no hacemos nada hasta que marque el checkbox
                updateTable();
            });
        }

        function showCsvData() {
            const fileInput = document.getElementById('csvFile');
            if (!fileInput.files[0]) {
                alert('Por favor, seleccione un archivo CSV');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const csv = event.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',');

                // Guardar datos del CSV para uso posterior
                csvData = lines;
                originalCsvData = lines.slice(); // Hacer una copia de los datos originales

                // Crear encabezados de la tabla
                const thead = document.querySelector('#csvTable thead');
                thead.innerHTML = '<tr>' + headers.map(header => 
                    `<th>${header.trim()}</th>`
                ).join('') + '</tr>';

                updateCsvTable(lines);

                // Mostrar el modal
                if (!csvModal) {
                    csvModal = new bootstrap.Modal(document.getElementById('csvModal'));
                }
                csvModal.show();
            };

            reader.readAsText(fileInput.files[0]);
        }

        function updateCsvTable(lines) {
            const tbody = document.querySelector('#csvTable tbody');
            tbody.innerHTML = '';

            // Mostrar solo las primeras 100 filas para mejor rendimiento
            const maxRows = Math.min(lines.length, 100);
            for (let i = 1; i < maxRows; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = line.split(',');
                const row = tbody.insertRow();
                values.forEach(value => {
                    row.insertCell().textContent = value.trim();
                });
            }

            // Mostrar mensaje si hay más de 100 filas
            if (lines.length > 100) {
                const messageRow = tbody.insertRow();
                const cell = messageRow.insertCell();
                cell.colSpan = lines[0].split(',').length;
                cell.className = 'text-center text-muted';
                cell.textContent = `Mostrando 100 de ${lines.length - 1} registros`;
            }
        }

        function applyFilters() {
            const nameFilter = document.getElementById('filterName').value.toLowerCase();
            const dateStart = document.getElementById('filterDateStart').value;
            const dateEnd = document.getElementById('filterDateEnd').value;

            // Filtrar los datos
            let filteredLines = originalCsvData.slice(0, 1); // Mantener la línea de encabezados
            
            for (let i = 1; i < originalCsvData.length; i++) {
                const line = originalCsvData[i].trim();
                if (!line) continue;

                const values = line.split(',');
                const name = values[1].toLowerCase();
                const date = values[2];

                // Aplicar filtros
                let includeRow = true;

                // Filtro por nombre
                if (nameFilter && !name.includes(nameFilter)) {
                    includeRow = false;
                }

                // Filtro por fecha
                if (dateStart && date < dateStart) {
                    includeRow = false;
                }
                if (dateEnd && date > dateEnd) {
                    includeRow = false;
                }

                if (includeRow) {
                    filteredLines.push(line);
                }
            }

            updateCsvTable(filteredLines);
        }

        function clearFilters() {
            // Limpiar los campos de filtro
            document.getElementById('filterName').value = '';
            document.getElementById('filterDateStart').value = '';
            document.getElementById('filterDateEnd').value = '';

            // Mostrar datos originales
            updateCsvTable(originalCsvData);
        }

        function processData() {
            const fileInput = document.getElementById('csvFile');
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!fileInput.files[0] || !startDate || !endDate) {
                alert('Por favor, seleccione un archivo CSV y el rango de fechas');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const csv = event.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',');

                // Crear objeto para almacenar datos por persona
                const personData = {};
                const allDates = new Set();
                
                // Primero, recolectar todas las fechas en el rango
                const start = new Date(startDate);
                const end = new Date(endDate);
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    allDates.add(d.toISOString().split('T')[0]);
                }

                // Procesar cada línea del CSV
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = line.split(',');
                    const name = values[1];
                    const date = values[2];

                    // Verificar si la fecha está en el rango seleccionado
                    if (date >= startDate && date <= endDate) {
                        if (!personData[name]) {
                            personData[name] = {
                                count: 0,
                                dates: new Set()
                            };
                        }

                        personData[name].count++;
                        personData[name].dates.add(date);
                    }
                }

                // Preparar datos para la tabla
                processedData = Object.entries(personData)
                    .map(([name, data]) => {
                        // Encontrar fechas sin asistencia
                        const missingDates = Array.from(allDates)
                            .filter(date => !data.dates.has(date))
                            .sort();

                        return {
                            name,
                            attendance: data.count,
                            missingCount: missingDates.length,
                            missingDates: missingDates.join(', ') || 'Ninguna'
                        };
                    })
                    .sort((a, b) => a.name.localeCompare(b.name));

                updateTable();
                document.getElementById('exportBtn').disabled = false;
            };

            reader.readAsText(fileInput.files[0]);
        }

        // Conjunto que guarda los nombres cuyas fechas se expandieron (ver más)
        const expandedSet = new Set();

        function getDisplayedData() {
            const onlyMissingCheckbox = document.getElementById('onlyMissing');
            const onlyMissing = onlyMissingCheckbox ? onlyMissingCheckbox.checked : false;
            const excludeRestCheckbox = document.getElementById('excludeRest');
            const excludeRest = excludeRestCheckbox ? excludeRestCheckbox.checked : false;
            const restDaySelect = document.getElementById('restDaySelect');
            const restDayVal = restDaySelect ? restDaySelect.value : '';

            // Función auxiliar para obtener día de la semana (0=Domingo..6=Sábado) a partir de YYYY-MM-DD
            function weekdayOf(dateStr) {
                // Añadir T00:00:00 para evitar problemas de zona horaria
                const d = new Date(dateStr + 'T00:00:00');
                return d.getDay();
            }

            // Mapear processedData y, si corresponde, excluir las fechas que coincidan con el día de descanso
            const mapped = processedData.map(p => {
                let datesArr = [];
                if (p.missingDates && p.missingDates !== 'Ninguna') {
                    datesArr = p.missingDates.split(',').map(s => s.trim()).filter(Boolean);
                }

                if (excludeRest && restDayVal) {
                    const restDayNum = parseInt(restDayVal, 10);
                    datesArr = datesArr.filter(dt => weekdayOf(dt) !== restDayNum);
                }

                return {
                    name: p.name,
                    attendance: p.attendance,
                    missingCount: datesArr.length,
                    missingDates: datesArr.length ? datesArr.join(', ') : 'Ninguna'
                };
            });

            if (!onlyMissing) return mapped;
            return mapped.filter(p => p.missingCount && p.missingCount > 0);
        }

        function toggleDetails(name) {
            if (expandedSet.has(name)) expandedSet.delete(name);
            else expandedSet.add(name);
            updateTable();
        }

        function updateTable() {
            const tbody = document.querySelector('#resultTable tbody');
            tbody.innerHTML = '';

            const displayed = getDisplayedData();
            const truncateCountInput = document.getElementById('truncateCount');
            const truncateCount = truncateCountInput ? parseInt(truncateCountInput.value, 10) || 5 : 5;

            displayed.forEach((person, index) => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = person.name;
                row.insertCell(2).textContent = person.attendance;
                row.insertCell(3).textContent = person.missingCount;

                const cell4 = row.insertCell(4);
                if (!person.missingDates || person.missingDates === 'Ninguna') {
                    cell4.textContent = 'Ninguna';
                } else {
                    const datesArr = person.missingDates.split(',').map(s => s.trim()).filter(Boolean);
                    const nameKey = person.name.replace(/'/g, "\\'");
                    if (expandedSet.has(person.name)) {
                        // Mostrar todo
                        cell4.innerHTML = datesArr.join(', ') + ` <a href="#" onclick="toggleDetails('${nameKey}');return false;">Ver menos</a>`;
                    } else if (datesArr.length > truncateCount) {
                        const shown = datesArr.slice(0, truncateCount).join(', ');
                        cell4.innerHTML = shown + `... <a href="#" onclick="toggleDetails('${nameKey}');return false;">Ver más</a>`;
                    } else {
                        cell4.textContent = datesArr.join(', ');
                    }
                }
            });
        }

        function exportToExcel() {
            const displayed = getDisplayedData();
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(displayed.map((person, index) => ({
                'N°': index + 1,
                'Nombre': person.name,
                'Número de Asistencias': person.attendance,
                'Días sin Asistencia': person.missingCount,
                'Fechas sin Asistencia': person.missingDates
            })));

            XLSX.utils.book_append_sheet(wb, ws, 'Asistencias');
            XLSX.writeFile(wb, 'reporte_asistencias.xlsx');
        }
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
